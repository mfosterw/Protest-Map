<!DOCTYPE html>
<html>

<head>
  <title>Protest Map</title>
  <link rel="icon" href="https://upload.wikimedia.org/wikipedia/commons/2/2a/Fist.svg">
  <meta name="viewport" content="initial-scale=1.0">
  <meta charset="utf-8">
  <style>
    #map {
      height: 100%;
    }

    /* center a div: https://stackoverflow.com/questions/9383163/how-do-i-position-a-div-at-the-bottom-center-of-the-screen */
    #sourcelink {
      position: fixed;
      left: 50%;
      bottom: 20px;
      transform: translate(-50%, -50%);
      margin: 0 auto;
    }

    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
  </style>
</head>

<body>
  <div id="container">
    <div id="map">
      <div id="loadmsg">
        The map is loading. If this takes too long, I'm sorry. This could also be an error, in which case you should email protestmapchicago@gmail.com to tell me.
      </div>
    </div>
    <div id="links">
      <a href="https://github.com/mfosterw/Protest-Map/tree/gh-pages" target='_blank'>Code and Sources</a>
    </div>
  </div>
  <script>
    var map;
    var infowindow;

    function initMap() {
      //Create map centered on continental US
      map = new google.maps.Map(document.getElementById('map'), {
        center: {
          lat: 39.83,
          lng: -98.583
        },
        zoom: 4.5
      });
      map.data.loadGeoJson('https://raw.githubusercontent.com/mfosterw/Protest-Map/master/scripts/files/geoprotest.json')

      map.data.setStyle(function(feature) {
        return {
          'title': feature.getProperty('title')
        };
      });

      infowindow = new google.maps.InfoWindow({});

      //Add infowindow popup to each marked point
      map.data.addListener('click', function(event) {
        var content =
          `<h1>${event.feature.getProperty("title")}</h1><hr />
        <p>${event.feature.getProperty("time_info")}</p>
        <p>${event.feature.getProperty("location")}</p><p>&nbsp;</p>
        <p>${event.feature.getProperty("notes")}</p>
        <p><a href="${event.feature.getProperty("url")}", target="blank">
        Source</a></p>`;

        //Adapted from https://stackoverflow.com/questions/48138226/google-maps-geojson-infowindow
        infowindow.setContent(content);
        infowindow.setPosition(event.feature.getGeometry().get());
        infowindow.setOptions({
          pixelOffset: new google.maps.Size(0, -30)
        });
        infowindow.open(map);
      });

      //Add a circle and center map on user location
      navigator.geolocation.getCurrentPosition(function(position) {
        var pos = {
          lat: position.coords.latitude,
          lng: position.coords.longitude
        };
        var marker = new google.maps.Marker({
          position: pos,
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 8
          },
          map: map
        });
        map.setCenter(pos);
        map.setZoom(10);
      });

      //remove loading message
      //based on https://stackoverflow.com/questions/20307549/display-loading-message-on-google-maps
      google.maps.event.addListener(map, 'tilesloaded', function() {
        var msg = document.getElementById('loadmsg');
        if (msg) {
          msg.parentNode.removeChild(msg);
        }
      });
    }
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAbhE2UHcmRKmq14Rk-TODAHKVwGkV5xG4&callback=initMap" async defer></script>
</body>

</html>
